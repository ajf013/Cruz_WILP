<#
.SYNOPSIS 
 Orphaned NIC Notification & Cleanup Runbook

.DESCRIPTION 
 Identifies unattached (orphaned) NICs across all subscriptions.
 Tags them with 'OrphanedSince' if not already tagged.
 Sends reminder emails on Day 7, 5, 3, 1.
 Sends protection notice if DO NOT DELETE = yes.
 Deletes NIC on Day 0 and emails actual cost savings in ‚Çπ INR.
#>

Import-Module Az.Accounts
Import-Module Az.Network
Import-Module Az.Resources
Import-Module Az.CostManagement

Connect-AzAccount -Identity

$SendGridApiKey = Get-AutomationVariable -Name "SendGridApiKey"
$FromEmail = "azureautomation@0dhbq.onmicrosoft.com"

function Send-Email {
    param (
        [string]$ToEmail,
        [string]$Subject,
        [string]$BodyHtml
    )

    $BodyJson = @{
        personalizations = @(@{to = @(@{email = $ToEmail})})
        from = @{email = $FromEmail}
        subject = $Subject
        content = @(@{type = "text/html"; value = $BodyHtml})
    }

    $jsonBody = $BodyJson | ConvertTo-Json -Depth 4

    Write-Host "Email Preview:"
    Write-Host $BodyHtml

    try {
        Invoke-RestMethod -Uri "https://api.sendgrid.com/v3/mail/send" `
            -Method Post `
            -Headers @{
                "Authorization" = "Bearer $SendGridApiKey"
                "Content-Type"  = "application/json"
            } `
            -Body $jsonBody

        Write-Host "‚úÖ Email sent to $ToEmail"
    }
    catch {
        Write-Host "‚ö†Ô∏è WARNING: Failed to send email to $ToEmail"
        Write-Host ("ERROR DETAILS: " + $_.Exception.Message)
        Write-Host ("FULL ERROR OBJECT: " + ($_ | Out-String))
    }
}

function Get-ActualNICCost {
    param (
        [string]$resourceId,
        [datetime]$startDate,
        [datetime]$endDate
    )

    try {
        $usageDetails = Get-ConsumptionUsageDetail -StartDate $startDate -EndDate $endDate
        $nicUsage = $usageDetails | Where-Object { $_.InstanceId -eq $resourceId }
        $totalCost = ($nicUsage | Measure-Object -Property PreTaxCost -Sum).Sum
        return [math]::Round($totalCost, 2)
    }
    catch {
        Write-Host "‚ö†Ô∏è Failed to retrieve actual cost for $resourceId. Falling back to estimate."
        return [math]::Round(1.00 * (($endDate - $startDate).Days), 2)
    }
}

$today = Get-Date
$subscriptions = Get-AzSubscription

foreach ($sub in $subscriptions) {
    Set-AzContext -SubscriptionId $sub.Id
    Write-Host "üîç Checking subscription: $($sub.Name)"

    $nics = Get-AzNetworkInterface | Where-Object { -not $_.VirtualMachine.Id }

    foreach ($nic in $nics) {
        $nicResource = Get-AzResource -ResourceId $nic.Id
        $tags = $nicResource.Tags

        $ownerEmail = if ($tags.ContainsKey("OwnerEmail")) { $tags["OwnerEmail"] } else { "jeni01anto@gmail.com" }

        if (-not $tags.ContainsKey("OrphanedSince")) {
            $tags["OrphanedSince"] = $today.ToString("yyyy-MM-dd")
            Set-AzResource -ResourceId $nic.Id -Tag $tags -Force
            Write-Host "üè∑Ô∏è Tagged NIC $($nic.Name) with OrphanedSince=$($tags["OrphanedSince"])"
        }

        Set-AzResource -ResourceId $nic.Id -Tag $tags -Force

        $orphanedDate = [datetime]::ParseExact($tags["OrphanedSince"], "yyyy-MM-dd", $null)
        $daysOrphaned = ($today - $orphanedDate).Days
        $daysLeft = 7 - $daysOrphaned
        $totalSaved = Get-ActualNICCost -resourceId $nic.Id -startDate $orphanedDate -endDate $today
        $doNotDelete = $tags.ContainsKey("DO NOT DELETE") -and $tags["DO NOT DELETE"].ToLower() -eq "yes"

        if ($doNotDelete) {
            $subject = "Info: NIC $($nic.Name) is protected from deletion"
            $bodyHtml = @"
<html>
  <body style='font-family: Georgia, serif; font-size:14px; color:#333;'>
    <p>Dear Owner,</p>
    <p>
      The following <b style='color:green;'>Network Interface (NIC)</b> is currently unattached but has been tagged with <b>DO NOT DELETE = yes</b>.
    </p>
    <table border='1' cellpadding='6' cellspacing='0' style='border-collapse: collapse;'>
      <tr style='background-color:#f2f2f2;'><th>Property</th><th>Value</th></tr>
      <tr><td><b>NIC Name</b></td><td>$($nic.Name)</td></tr>
      <tr><td><b>Resource Group</b></td><td>$($nic.ResourceGroupName)</td></tr>
      <tr><td><b>Subscription</b></td><td>$($sub.Name)</td></tr>
      <tr><td><b>Location</b></td><td>$($nic.Location)</td></tr>
      <tr><td><b>Current Cost</b></td><td>&#8377;$totalSaved</td></tr>
    </table>
    <p>This resource is <b>excluded from automated deletion</b>. No action is required from your end at the moment.</p>
    <p>We encourage periodic review to ensure it's still needed. If not, please update the tag value to allow automated cleanup.</p>
    <p style='margin-top:20px;'>Regards,<br/>Azure Automation Team</p>
  </body>
</html>
"@
            Send-Email -ToEmail $ownerEmail -Subject $subject -BodyHtml $bodyHtml
            continue
        }

        if ($daysLeft -in @(7,5,3,1)) {
            switch ($daysLeft) {
                5 { $note = "This is a reminder notification (5th day)." }
                3 { $note = "This is a reminder notification (3rd day)." }
                1 { $note = "This is the final reminder before deletion." }
                default { $note = "This is the first notification (7th day)." }
            }

            $subject = "Reminder: NIC $($nic.Name) will be deleted in $daysLeft day(s)"
            $bodyHtml = @"
<html>
  <body style='font-family: Georgia, serif; font-size:14px; color:#333;'>
    <p>Dear Owner, Good Day...</p>
    <p>
    We‚Äôve identified the following orphaned resource <b style='color:red;'>Network Interface (NIC)</b> under your subscription that is currently unused and not linked to any virtual machine:
    </p>
    <table border='1' cellpadding='6' cellspacing='0' style='border-collapse: collapse;'>
      <tr style='background-color:#f2f2f2;'><th>Property</th><th>Value</th></tr>
      <tr><td><b>NIC Name</b></td><td>$($nic.Name)</td></tr>
      <tr><td><b>Resource Group</b></td><td>$($nic.ResourceGroupName)</td></tr>
      <tr><td><b>Subscription</b></td><td>$($sub.Name)</td></tr>
      <tr><td><b>Location</b></td><td>$($nic.Location)</td></tr>
      <tr><td><b>Actual Cost So Far</b></td><td>&#8377;$totalSaved</td></tr>
    </table>
    <p>
      As part of our cleanup initiative to optimize cloud usage and reduce unnecessary costs, this resource will be deleted as per the automation schedule. Our Automation process will <b>delete this NIC after $daysLeft day(s)</b>. $note
    </p>
    <p>If this resource is still required, please tag it with <i>DO NOT DELETE</i> or reattach it to a VM before the resource gets deleted automatically.</p>
    <p><b>If deleted, this NIC would save &#8377;$totalSaved.</b></p>
    <p style='margin-top:20px;'>Regards,<br/>Azure Automation Team</p>
  </body>
</html>
"@
            Send-Email -ToEmail $ownerEmail -Subject $subject -BodyHtml $bodyHtml
        }

        elseif ($daysLeft -eq 0) {
            if (-not $doNotDelete) {
                Remove-AzNetworkInterface -Name $nic.Name -ResourceGroupName $nic.ResourceGroupName -Force
                Write-Host "üóëÔ∏è Deleted NIC $($nic.Name)"

                $subject = "Deleted: Orphaned NIC $($nic.Name)"
                $bodyHtml = @"
<html>
  <body style='font-family: Georgia, serif; font-size:14px; color:#333;'>
    <p>Dear Owner,</p>
    <p>
      The following Network Interface (NIC) has been <b style='color:red;'>deleted</b> after 7 days of being unattached. This helps reduce unnecessary cost.
    </p>
    <table border='1' cellpadding='6' cellspacing='0' style='border-collapse: collapse;'>
      <tr style='background-color:#f2f2f2;'><th>Property</th><th>Value</th></tr>
      <tr><td><b>NIC Name</b></td><td>$($nic.Name)</td></tr>
      <tr><td><b>Resource Group</b></td><td>$($nic.ResourceGroupName)</td></tr>
      <tr><td><b>Subscription</b></td><td>$($sub.Name)</td></tr>
      <tr><td><b>Location</b></td><td>$($nic.Location)</td></tr>
      <tr><td><b>Actual Cost Saved</b></td><td>&#8377;$totalSaved</td></tr>
    </table>
    <p style='color:green;'><b>NIC deleted successfully.</b> Thank you for helping optimize cloud costs!</p>
    <p>Regards,<br/>Azure Automation Team</p>
  </body>
</html>
"@
                Send-Email -ToEmail $ownerEmail -Subject $subject -BodyHtml $bodyHtml
            }
        }
    }
}

Write-Host "‚úÖ Orphaned NIC cleanup completed."
